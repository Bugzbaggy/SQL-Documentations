<#
    .NOTES 
    Name: SQL Vulnerability Assessment
    Author: Renz Marion Bagasbas
	            
    .DESCRIPTION 
        SQL Vulnerability Assessment (VA) is a service that provides visibility into your security state, and includes actionable steps to resolve security issues, and enhance your database security. It can help you:
		#Meet compliance requirements that require database scan reports.
		#Meet data privacy standards.
		#Monitor a dynamic database environment where changes are difficult to track.
		
		VA runs vulnerability scans on your database, flagging security vulnerabilities and highlight deviations from best practices, such as misconfigurations, excessive permissions, and unprotected sensitive data. The rules are based on Microsoft’s best practices and focus on the security issues that present the biggest risks to your database and its valuable data. These rules also represent many of the requirements from various regulatory bodies to meet their compliance standards.

        YOU WILL NEED TO LIST DOWN ALL SQL SERVERS IN THE SOURCE FILE
#> 

$dbservers = Get-Content "C:\Temp\test.txt" #List of all SQL servers

$outputarray = @()
ForEach($server in $dbservers){
    Write-host -nonewline "."
    $SQLService = (Get-service -ComputerName $server | where {($_.displayname -like "SQL Server (*") }).Name
    $ServerInstanceSplit = $SQLService.Split("$")
    $InstanceName = $server + '\' + $ServerInstanceSplit[1]
           
        $StartDate = Get-Date
		Write-Host "
		##########################################
		SQL Vulnerability Assessment initiated...
		Time Script Started $StartDate" -ForegroundColor Green

       If($Service.Status -ne "Running"){
		
        Start-Service -Name $SQLService
        $scanResult = Invoke-SqlVulnerabilityAssessmentScan -ServerInstance $($InstanceName) -Database “master”
		$scanResult | Export-SqlVulnerabilityAssessmentScan -FolderPath “D:\$server.xlsx”
       }
       ElseIf($Service.Status -eq "Running"){
       
        $scanResult = Invoke-SqlVulnerabilityAssessmentScan -ServerInstance $($InstanceName) -Database “master”
        $scanResult | Export-SqlVulnerabilityAssessmentScan -FolderPath “D:\$server.xlsx”
       }

    $EndDate = Get-Date
    $Time = $EndDate - $StartDate
    Write-Host "
    ##########################################
    Vulnerability assessment results saved...
    Time Script ended at $EndDate and took
    $Time" -ForegroundColor Green
    	  
    
    }
   

